<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
   <meta name="description" content="Test site : ">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>DI Builder</title>
	
	<style>
canvas {
    border: 1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
	
  </head>

  <body onload = "startScript()">
	
	
<script>

var masterNode;

class Node{
	constructor(type){
		this.type = type;
		this.subs = [];
	}
	addNext(node){
		this.subs.push(node);
	}
	addPrev(node){
		this.subs.unshift(node);
	}
	stage(ctx, x, y){
		this.subs.forEach(function(item, index, array) {
			item.stage(ctx, x, y);
		});
	}
	repaint(){
		this.subs.forEach(function(item, index, array) {
			item.repaint();
		});
	}
}

class Leaf extends Node{
	constructor(ctx, text){
		super('leaf');
				ctx.font = "20px arial";

		this.text = text;
		this.width = ctx.measureText(this.text).width;
		// based on tested height of font for now - tricky problem
		this.height = 20;
	}
	stage(ctx, x, y){
		this.ctx = ctx;
		this.x = x;
		this.y = y;
	}
	repaint(){
		if(this.ctx == null || this.x == null || this.y == null) return;
		this.ctx.font = "20px arial";
		//	ctx.fillStyle="#0000FF";
		this.ctx.fillText(this.text, this.x - this.width/2, this.y);
	}
}

class hjoin extends Node{
	constructor(){
		super('hjoin');
		this.hspace = 5;
	}
	addLeft(node){
		this.addPrev(node);
	}
	addRight(node){
		this.addNext(node);
	}
	getHeight(ctx){
		var maxHeight = 0;
		this.subs.forEach(function(item, index, array) {
			if(item.height == null) return;
			if(item.height > maxHeight) maxHeight = item.height;
		});
		return maxHeight;
	}
	getWidth(ctx){
		var totalWidth = 0;
		this.subs.forEach(function(item, index, array) {
			if(item.width == null) return;
			totalWidth += item.width;
		});
		totalWidth += (this.subs.length - 1) * this.hspace;
		return totalWidth;
	}
}		

class vjoin extends Node{
	constructor(){
		super('vjoin');
		this.vspace = 5;
	}
	addAbove(node){
		this.addPrev(node);
	}
	addBelow(node){
		this.addNext(node);
	}
	getHeight(ctx){
		var totalHeight = 0;
		this.subs.forEach(function(item, index, array) {
			if(item.height == null) return;
			totalHeight += item.height;
		});
		totalHeight += (this.subs.length - 1) * this.vspace;
		return totalHeight;
	}
	getWidth(ctx){
		var maxWidth = 0;
		this.subs.forEach(function(item, index, array) {
			if(item.width == null) return;
			if(item.width > maxWidth) maxWidth = item.width;
		});
		return maxWidth;
	}
	stage(ctx, x, y){
		this.ctx = ctx;
		this.x = x;
		this.y = y;
		var top = y - this.getHeight()/2;
		this.lines = [];
		for (let item of this.subs) {
			item.stage(ctx, x, top);
			top += item.height;
			top += this.vspace/2;
			this.lines.push(top);
			top += this.vspace/2;
		};
		if(this.lines.length > 0) this.lines.pop();
	}
	repaint(){
		this.ctx.textBaseline = 'top';
		this.subs.forEach(function(item, index, array) {
			item.repaint();
		});
		this.ctx.beginPath();
		for (let item of this.lines){
			this.ctx.moveTo((this.x - this.getWidth(this.ctx)/2), item);
			this.ctx.lineTo((this.x + this.getWidth(this.ctx)/2), item);
		}
		this.ctx.stroke();
	}
}

function startScript(){
	myCanvas.start();
	masterNode = new Node();
}

function textPrintNodes(node, depth){
	if(node == undefined || node == null){
		return;
	}
	while(depth > 0){
		document.body.appendChild(document.createTextNode('\u00A0\u00A0\u00A0\u00A0'));
		depth = depth - 1;
	}
	if(node.type === 'leaf'){
		document.body.appendChild(document.createTextNode(node.text));
	}
	else{
		document.body.appendChild(document.createTextNode(node.type));
	}
	document.body.appendChild(document.createElement('br'));
	if(node.subs != null){
		node.subs.forEach(function(item, index, array) {
		textPrintNodes(item, depth + 1);
		});
	}
}

var myCanvas = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 480;
        this.canvas.height = 270;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
		document.body.appendChild(document.createElement('br'))
//		window.addEventListener('keydown', function(e){keyMove(e.keyCode);});
//		this.interval = setInterval(updateCanvas, (1000/30));
    },
	clear : function(){
		this.context.clearRect(0,0, this.canvas.width, this.canvas.height);
	}
}

function repaintAll() {
    myCanvas.clear();
	if(masterNode != null){
		masterNode.stage(myCanvas.context, 240, 135);
		masterNode.repaint();
	}
}

var vDemo = {
	start : function() {
		masterNode = new vjoin();
		this.nodes = [];
		this.n = 1;
		this.next();
	},
	next : function() {
		var newNode = new Leaf(myCanvas.context, this.n + ' x ' + (this.n + 1));
		masterNode.addBelow(newNode);
		this.n += 2;
		repaintAll();
	}
}

</script>
<br><br>
<button onclick="repaintAll()">Repaint</button>
<button onclick="myCanvas.clear()">Clear</button>
<button onclick="textPrintNodes(masterNode, 0)">textPrintNodes</button>
<button onclick="vDemo.start()">vDemoStart</button>
<button onclick="vDemo.next()">vDemoNext</button>

  </body>
</html>
